{% extends "artisan_base.html" %}

{% block title %}Location - Artisan Portal{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<style>
    #locationMap { 
        height: 500px; 
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .location-card {
        background: white;
        border-radius: 10px;
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2 class="fw-bold">Location Settings</h2>
        <p class="text-muted">Update your location to get nearby job requests</p>
    </div>
</div>

<div class="row">
    <!-- Map Section -->
    <div class="col-md-8 mb-4">
        <div class="location-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold mb-0">Your Location on Map</h5>
                <div class="btn-group">
                    <button class="btn btn-outline-primary btn-sm" onclick="getCurrentLocation()">
                        <i class="fas fa-location-arrow me-2"></i> Use My Location
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="refreshMap()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div id="locationMap"></div>
        </div>
    </div>
    
    <!-- Location Details -->
    <div class="col-md-4">
        <div class="location-card p-4 mb-4">
            <h5 class="fw-bold mb-4">Location Details</h5>
            
            <div class="mb-4">
                <small class="text-muted d-block">Current Location</small>
                <h6 class="fw-bold">{{ artisan.location|default('Not set') }}</h6>
            </div>
            
            <div class="mb-4">
                <small class="text-muted d-block">Town/City</small>
                <h6 class="fw-bold">{{ artisan.town|default('Not set') }}</h6>
            </div>
            
            <div class="mb-4">
                <small class="text-muted d-block">Region</small>
                <h6 class="fw-bold">{{ artisan.region|default('Not set') }}</h6>
            </div>
            
            <div class="mb-4">
                <small class="text-muted d-block">GPS Coordinates</small>
                <div class="input-group">
                    <input type="text" id="coordinates" class="form-control" value="5.6037, -0.1870" readonly>
                    <button class="btn btn-outline-secondary" onclick="copyCoordinates()">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Your location helps clients find you for nearby jobs. Update regularly for best results.
            </div>
        </div>
        
        <!-- Update Location Form -->
        <div class="location-card p-4">
            <h5 class="fw-bold mb-4">Update Location</h5>
            
            <form id="updateLocationForm">
                <div class="mb-3">
                    <label class="form-label">Full Address</label>
                    <input type="text" id="addressInput" class="form-control" placeholder="Enter your full address" value="{{ artisan.location|default('') }}">
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">Town/City</label>
                        <input type="text" id="townInput" class="form-control" placeholder="Town" value="{{ artisan.town|default('') }}">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Region</label>
                        <select id="regionInput" class="form-select">
                            <option value="">Select Region</option>
                            {% for region in regions %}
                            <option value="{{ region }}" {% if artisan.region == region %}selected{% endif %}>{{ region }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">GhanaPost GPS</label>
                    <input type="text" id="gpsInput" class="form-control" placeholder="GA-XXX-XXXX" value="{{ artisan.digital_address|default('') }}">
                </div>
                
                <div class="d-grid">
                    <button type="button" class="btn btn-warning" onclick="updateLocation()">
                        <i class="fas fa-save me-2"></i> Save Location
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Coverage Area -->
<div class="location-card p-4 mt-4">
    <h5 class="fw-bold mb-4">Coverage Area</h5>
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Maximum Distance (km)</label>
                <input type="range" class="form-range" min="5" max="50" value="{{ coverage_distance|default('20') }}" id="coverageRange" onchange="updateCoverageDistance(this.value)">
                <div class="d-flex justify-content-between">
                    <small>5km</small>
                    <small id="currentDistance">{{ coverage_distance|default('20') }}km</small>
                    <small>50km</small>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-warning">
                <h6><i class="fas fa-map-pin me-2"></i> Coverage Info</h6>
                <p class="mb-2">Jobs within your coverage area will be shown to you first.</p>
                <small class="text-muted">Smaller distance = More relevant jobs</small>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script>
    let map;
    let marker;
    let currentLocation = [5.6037, -0.1870]; // Default to Accra
    
    // Initialize map
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        
        // Try to get user's current location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLocation = [position.coords.latitude, position.coords.longitude];
                    updateMap();
                },
                function(error) {
                    console.log("Geolocation error:", error);
                    useDefaultLocation();
                }
            );
        } else {
            useDefaultLocation();
        }
    });
    
    function initMap() {
        map = L.map('locationMap').setView(currentLocation, 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // Add geocoder control
        L.Control.geocoder({
            defaultMarkGeocode: false
        })
        .on('markgeocode', function(e) {
            const location = e.geocode.center;
            currentLocation = [location.lat, location.lng];
            updateMap();
            document.getElementById('addressInput').value = e.geocode.name;
        })
        .addTo(map);
        
        updateMap();
    }
    
    function updateMap() {
        // Remove existing marker
        if (marker) {
            map.removeLayer(marker);
        }
        
        // Add new marker
        marker = L.marker(currentLocation, {
            draggable: true,
            icon: L.divIcon({
                className: 'user-marker',
                html: '<div style="background: #FF4500; width: 40px; height: 40px; border-radius: 50%; border: 4px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>',
                iconSize: [40, 40]
            })
        })
        .addTo(map)
        .bindPopup('<strong>Your Location</strong><br>Drag to adjust')
        .openPopup();
        
        // Update coordinates display
        document.getElementById('coordinates').value = currentLocation[0].toFixed(4) + ', ' + currentLocation[1].toFixed(4);
        
        // Center map
        map.setView(currentLocation, 13);
        
        // Add drag end event
        marker.on('dragend', function(event) {
            const position = marker.getLatLng();
            currentLocation = [position.lat, position.lng];
            document.getElementById('coordinates').value = position.lat.toFixed(4) + ', ' + position.lng.toFixed(4);
        });
    }
    
    function useDefaultLocation() {
        currentLocation = [5.6037, -0.1870]; // Accra coordinates
        updateMap();
    }
    
    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLocation = [position.coords.latitude, position.coords.longitude];
                    updateMap();
                    alert('Location updated from GPS!');
                },
                function(error) {
                    alert('Unable to get your location. Please enter it manually.');
                }
            );
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    }
    
    function refreshMap() {
        map.invalidateSize();
        alert('Map refreshed!');
    }
    
    function copyCoordinates() {
        const coords = document.getElementById('coordinates');
        coords.select();
        coords.setSelectionRange(0, 99999); // For mobile devices
        document.execCommand('copy');
        alert('Coordinates copied to clipboard!');
    }
    
    function updateLocation() {
        const address = document.getElementById('addressInput').value;
        const town = document.getElementById('townInput').value;
        const region = document.getElementById('regionInput').value;
        const gps = document.getElementById('gpsInput').value;
        
        if (!address || !town || !region) {
            alert('Please fill in address, town, and region.');
            return;
        }
        
        // In a real app, you would geocode the address here
        fetch('{{ url_for("update_artisan_location") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                address: address,
                town: town,
                region: region,
                gps: gps,
                coordinates: currentLocation
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Location updated successfully!');
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
    
    function updateCoverageDistance(distance) {
        document.getElementById('currentDistance').textContent = distance + 'km';
        
        fetch('{{ url_for("update_coverage_distance") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ distance: distance })
        });
    }
</script>
{% endblock %}
{% endblock %}