{% extends "artisan_base.html" %}

{% block title %}Dashboard - Artisan Portal{% endblock %}

{% block content %}
<div class="row">
    <!-- Profile Card -->
    <div class="col-md-4 mb-4">
        <div class="artisan-profile-card p-4 text-center">
            <div class="position-relative mb-3">
                <img src="{{ artisan.image_url }}" alt="{{ artisan.full_name }}" 
                     class="rounded-circle border border-3 border-warning" width="120" height="120" style="object-fit: cover;"
                     onerror="this.src='https://ui-avatars.com/api/?name={{ artisan.full_name|urlencode }}&background=FF4500&color=fff'">
                <label for="imageUpload" class="position-absolute bottom-0 end-0 bg-dark text-white rounded-circle p-2" style="cursor: pointer;">
                    <i class="fas fa-camera"></i>
                </label>
                <input type="file" id="imageUpload" accept="image/*" class="d-none" onchange="uploadProfileImage(this)">
            </div>
            <h4 class="fw-bold mb-1">{{ artisan.full_name }}</h4>
            <p class="text-muted mb-2">{{ artisan.trade }}</p>
            <div class="d-flex justify-content-center gap-2 mb-3">
                <span class="badge bg-{% if artisan.status == 'Available' %}success{% else %}warning{% endif %}">
                    {{ artisan.status }}
                </span>
                <span class="badge bg-warning text-dark">
                    <i class="fas fa-star"></i> {{ artisan.rating|default('5.0') }}
                </span>
            </div>
            
            <div class="mb-3">
                <small class="text-muted d-block">Location</small>
                <p class="mb-0">{{ artisan.location|default('Not set') }}</p>
            </div>
            
            <div class="d-grid gap-2">
                <button class="btn btn-{% if artisan.status == 'Available' %}outline-warning{% else %}success{% endif %}" onclick="toggleStatus()">
                    {% if artisan.status == 'Available' %}
                    <i class="fas fa-toggle-on me-2"></i> Go Offline
                    {% else %}
                    <i class="fas fa-toggle-off me-2"></i> Go Online
                    {% endif %}
                </button>
                <a href="{{ url_for('artisan_profile') }}" class="btn btn-outline-dark">
                    <i class="fas fa-edit me-2"></i> Edit Profile
                </a>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="artisan-stats-card p-3 mt-3">
            <h6 class="fw-bold mb-3">Quick Stats</h6>
            <div class="row">
                <div class="col-6 mb-2">
                    <small class="text-muted d-block">Jobs Done</small>
                    <h5 class="fw-bold mb-0">{{ completed_jobs_count|default('0') }}</h5>
                </div>
                <div class="col-6 mb-2">
                    <small class="text-muted d-block">Success Rate</small>
                    <h5 class="fw-bold mb-0">{{ (artisan.rating * 20)|default('100') }}%</h5>
                </div>
                <div class="col-6 mb-2">
                    <small class="text-muted d-block">Response Time</small>
                    <h5 class="fw-bold mb-0">2.3h</h5>
                </div>
                <div class="col-6 mb-2">
                    <small class="text-muted d-block">Commission</small>
                    <h5 class="fw-bold mb-0">15%</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="col-md-8">
        <!-- Welcome Card -->
        <div class="artisan-profile-card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="fw-bold mb-1">Welcome back, {{ artisan.full_name.split()[0] }}!</h3>
                    <p class="text-muted mb-0">Here's what's happening with your work today.</p>
                </div>
                <div class="text-end">
                    <small class="text-muted d-block">Today's Date</small>
                    <h5 class="fw-bold mb-0">{{ current_date }}</h5>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="artisan-stats-card p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Available Jobs</h6>
                            <h2 class="fw-bold mb-0">{{ available_jobs_count|default('0') }}</h2>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-briefcase text-warning fa-lg"></i>
                        </div>
                    </div>
                    <small class="text-muted">Near your location</small>
                    <div class="mt-2">
                        <a href="{{ url_for('artisan_jobs') }}" class="btn btn-sm btn-outline-warning">View Jobs</a>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="artisan-stats-card p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Active Jobs</h6>
                            <h2 class="fw-bold mb-0">{{ active_jobs_count|default('0') }}</h2>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-tasks text-info fa-lg"></i>
                        </div>
                    </div>
                    <small class="text-muted">In progress</small>
                    <div class="mt-2">
                        <a href="{{ url_for('artisan_my_jobs') }}" class="btn btn-sm btn-outline-info">Manage</a>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="artisan-stats-card p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">This Month</h6>
                            <h2 class="fw-bold mb-0">GH₵ {{ monthly_earnings|default('0') }}</h2>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-money-bill-wave text-success fa-lg"></i>
                        </div>
                    </div>
                    <small class="text-muted">After commission</small>
                    <div class="mt-2">
                        <a href="{{ url_for('artisan_earnings') }}" class="btn btn-sm btn-outline-success">View Earnings</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="artisan-profile-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0">Recent Activity</h5>
                <a href="{{ url_for('artisan_my_jobs') }}" class="btn btn-sm btn-outline-dark">View All</a>
            </div>
            
            {% if recent_activities %}
            <div class="list-group">
                {% for activity in recent_activities %}
                <div class="list-group-item border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-bold mb-1">{{ activity.title }}</h6>
                            <p class="text-muted small mb-0">{{ activity.description }}</p>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block">{{ activity.time }}</small>
                            {% if activity.amount %}
                            <span class="badge bg-success">GH₵ {{ activity.amount }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-history fa-2x text-muted opacity-50 mb-3"></i>
                <p class="text-muted">No recent activity</p>
                <a href="{{ url_for('artisan_jobs') }}" class="btn btn-warning btn-sm">
                    <i class="fas fa-briefcase me-2"></i> Find Jobs
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Quick Actions -->
        <div class="artisan-profile-card p-4 mt-4">
            <h5 class="fw-bold mb-3">Quick Actions</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <a href="{{ url_for('artisan_location') }}" class="btn btn-outline-primary w-100">
                        <i class="fas fa-map-marker-alt me-2"></i> Update Location
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="{{ url_for('artisan_profile') }}" class="btn btn-outline-dark w-100">
                        <i class="fas fa-id-card me-2"></i> Update Profile
                    </a>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-success w-100" onclick="requestWork()">
                        <i class="fas fa-bullhorn me-2"></i> Request Work
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Request Work Modal -->
<div class="modal fade" id="requestWorkModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Work</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="workRequestForm">
                    <div class="mb-3">
                        <label class="form-label">What type of work do you need?</label>
                        <input type="text" class="form-control" placeholder="e.g., I need more plumbing jobs" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Preferred Location</label>
                        <input type="text" class="form-control" value="{{ artisan.location }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Budget Range (GH₵)</label>
                        <div class="row">
                            <div class="col-6">
                                <input type="number" class="form-control" placeholder="Min" min="50">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control" placeholder="Max" max="5000">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitWorkRequest()">Submit Request</button>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleStatus() {
        const newStatus = '{{ artisan.status }}' === 'Available' ? 'Busy' : 'Available';
        
        fetch('{{ url_for("update_artisan_status") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            }
        });
    }
    
    function uploadProfileImage(input) {
        if (input.files && input.files[0]) {
            const formData = new FormData();
            formData.append('image', input.files[0]);
            
            fetch('{{ url_for("upload_profile_image") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Profile image uploaded! Awaiting admin approval.');
                    // Preview the uploaded image
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.querySelector('img[alt="{{ artisan.full_name }}"]').src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                } else {
                    alert('Upload failed: ' + data.error);
                }
            });
        }
    }
    
    function requestWork() {
        new bootstrap.Modal(document.getElementById('requestWorkModal')).show();
    }
    
    function submitWorkRequest() {
        const form = document.getElementById('workRequestForm');
        if (form.checkValidity()) {
            alert('Work request submitted! We will notify you of matching jobs.');
            bootstrap.Modal.getInstance(document.getElementById('requestWorkModal')).hide();
        } else {
            form.reportValidity();
        }
    }
</script>
{% endblock %}