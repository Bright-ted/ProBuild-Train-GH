{% extends "base.html" %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                <div class="card-header bg-warning text-white py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-calendar-check me-2"></i> Confirm Booking</h5>
                </div>
                
                <div class="card-body p-4 bg-white">
                    
                    <div class="d-flex align-items-center mb-4 p-3 bg-light rounded-3">
                        <img src="{{ artisan.image_url }}" class="rounded-circle me-3" width="60" height="60" style="object-fit: cover;">
                        <div>
                            <h5 class="fw-bold mb-0 text-dark">{{ artisan.full_name }}</h5>
                            <span class="badge bg-dark">{{ artisan.trade }}</span>
                            <div class="text-muted small mt-1"><i class="fas fa-lock"></i> Contact hidden until booking</div>
                        </div>
                        <div class="ms-auto text-end">
                            <small class="text-muted d-block">Base Fee</small>
                            <span class="fw-bold text-success fs-5">GHâ‚µ <span id="displayAmount">{{ artisan.price_range }}</span></span>
                        </div>
                    </div>

                    <form id="bookingForm" action="{{ url_for('book_artisan', artisan_id=artisan.id) }}" method="POST">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted text-uppercase">Where is the job?</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="fas fa-map-pin text-danger"></i></span>
                                <input type="text" name="location" id="locationInput" class="form-control" placeholder="e.g. House No. 12, East Legon" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted text-uppercase">What needs to be done?</label>
                            <input type="text" name="job_title" id="jobInput" class="form-control" placeholder="e.g. Fix broken sink pipe" required>
                        </div>

                        <div class="form-check bg-light p-3 rounded-3 mb-4">
                            <input class="form-check-input" type="checkbox" name="notify_others" id="notifyCheck">
                            <label class="form-check-label small" for="notifyCheck">
                                <strong>Urgent?</strong> If {{ artisan.full_name.split()[0] }} is busy, notify other {{ artisan.trade }}s in {{ artisan.location }}?
                            </label>
                        </div>

                        <div class="d-grid">
                            <button type="button" class="btn btn-dark btn-lg fw-bold shadow-sm" onclick="startPaymentFlow()">
                                Pay & Confirm Booking <i class="fas fa-lock ms-2"></i>
                            </button>
                            <small class="text-center text-muted mt-2"><i class="fas fa-shield-alt text-success"></i> Payments held in Escrow.</small>
                        </div>

                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="paymentOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex justify-content-center align-items-center" style="z-index: 1050;">
    
    <div id="loadingStep" class="text-center text-white">
        <div class="spinner-border text-warning" style="width: 4rem; height: 4rem;" role="status"></div>
        <h5 class="mt-3 fw-bold">Connecting to Payment Gateway...</h5>
        <p class="small text-white-50">Please wait.</p>
    </div>

    <div id="methodStep" class="card p-4 rounded-4 shadow-lg d-none" style="width: 90%; max-width: 400px;">
        <h5 class="fw-bold text-center mb-4">Choose Payment Mode</h5>
        <div class="row g-3">
            <div class="col-6">
                <div class="payment-option border rounded-3 p-3 text-center cursor-pointer" onclick="selectProvider('MTN MoMo', '#ffcc00')">
                    <i class="fas fa-mobile-alt fa-2x mb-2 text-dark"></i>
                    <h6 class="mb-0 fw-bold small">MTN MoMo</h6>
                </div>
            </div>
            <div class="col-6">
                <div class="payment-option border rounded-3 p-3 text-center cursor-pointer" onclick="selectProvider('Telecel Cash', '#e60000')">
                    <i class="fas fa-sim-card fa-2x mb-2 text-danger"></i>
                    <h6 class="mb-0 fw-bold small">Telecel</h6>
                </div>
            </div>
            <div class="col-6">
                <div class="payment-option border rounded-3 p-3 text-center cursor-pointer" onclick="selectProvider('AT Money', '#0000ff')">
                    <i class="fas fa-wifi fa-2x mb-2 text-primary"></i>
                    <h6 class="mb-0 fw-bold small">AT Money</h6>
                </div>
            </div>
            <div class="col-6">
                <div class="payment-option border rounded-3 p-3 text-center cursor-pointer" onclick="selectProvider('Bank Card', '#333')">
                    <i class="fas fa-credit-card fa-2x mb-2 text-dark"></i>
                    <h6 class="mb-0 fw-bold small">Bank Card</h6>
                </div>
            </div>
        </div>
        <button class="btn btn-light btn-sm mt-4 w-100" onclick="closeOverlay()">Cancel</button>
    </div>

    <div id="momoPrompt" class="card p-0 rounded-0 shadow-lg d-none" style="width: 300px; border: 2px solid #fff;">
        <div class="card-header text-white fw-bold py-2" id="momoHeader" style="background-color: #004f71;">
            Payment Prompt
        </div>
        <div class="card-body bg-light text-center p-4">
            <p class="mb-3 text-dark fw-bold">
                Authorize payment of <br>
                <span class="fs-4">GHS {{ artisan.price_range }}.00</span> <br>
                to PROBUILD GHANA?
            </p>
            <p class="small text-muted mb-4">Ref: {{ artisan.trade }}-{{ artisan.id }}</p>
            
            <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-outline-danger btn-sm px-4" onclick="closeOverlay()">No</button>
                <button class="btn btn-success btn-sm px-4 fw-bold" onclick="finalizeBooking()">Yes</button>
            </div>
        </div>
    </div>

</div>

<style>
    .cursor-pointer { cursor: pointer; transition: all 0.2s; }
    .payment-option:hover { background-color: #f8f9fa; border-color: var(--brand-orange) !important; transform: scale(1.05); }
</style>

<script>
    function startPaymentFlow() {
        // 1. Validate Form First
        const location = document.getElementById('locationInput').value;
        const job = document.getElementById('jobInput').value;
        
        if (!location || !job) {
            alert("Please fill in the Location and Job Description first.");
            return;
        }

        // 2. Show Overlay & Spinner
        document.getElementById('paymentOverlay').classList.remove('d-none');
        document.getElementById('loadingStep').classList.remove('d-none');
        document.getElementById('methodStep').classList.add('d-none');
        document.getElementById('momoPrompt').classList.add('d-none');

        // 3. Wait 5 seconds, then show Payment Methods
        setTimeout(() => {
            document.getElementById('loadingStep').classList.add('d-none');
            document.getElementById('methodStep').classList.remove('d-none');
        }, 3000); // 3 seconds is usually enough, 5 feels too long for users
    }

    function selectProvider(providerName, color) {
        // Hide methods, show MoMo Prompt
        document.getElementById('methodStep').classList.add('d-none');
        
        // Customize the prompt color based on provider
        const header = document.getElementById('momoHeader');
        if (providerName.includes('MTN')) header.style.backgroundColor = '#ffcc00'; // Yellow
        else if (providerName.includes('Telecel')) header.style.backgroundColor = '#e60000'; // Red
        else header.style.backgroundColor = '#004f71'; // Default Blue
        
        if(providerName.includes('MTN')) header.style.color = '#000';
        else header.style.color = '#fff';

        header.innerText = providerName + " Authorization";
        
        document.getElementById('momoPrompt').classList.remove('d-none');
    }

    function finalizeBooking() {
        // Submit the real form to the database
        document.getElementById('bookingForm').submit();
    }

    function closeOverlay() {
        document.getElementById('paymentOverlay').classList.add('d-none');
    }
</script>

{% endblock %}